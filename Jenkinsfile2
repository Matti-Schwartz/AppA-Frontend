pipeline {
	agent any
	environment {
		DOCKER_HUB_CREDS = credentials('Docker-Hub-Creds-ms')
	}
	stages {
		stage ('Tooling versions') {
			steps {
				sh 'docker --version'
				sh 'docker compose version'
				sh 'terraform --version'
				sh 'ansible --version'
			}
		}
		stage ('Build') {
			steps {
				sh 'docker context use default'
				sh 'docker compose build'
				sh 'echo $DOCKER_HUB_CREDS_PSW | docker login -u $DOCKER_HUB_CREDS_USR --password-stdin'
				sh 'docker compose push'
			}
		}
        stage ('Terraform') {
            steps {
				sh 'terraform init'
                sh 'terraform apply -var \'sshPublicKeyPath=./.ssh/operator.pub\' --auto-approve'
            }
        }
	}
}