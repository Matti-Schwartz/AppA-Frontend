pipeline {
	agent any
	stages {
		stage ('Tooling versions') {
			steps {
				sh 'docker --version'
				sh 'docker compose version'
				sh 'terraform --version'
				sh 'ansible --version'
			}
		}
		stage ('Build') {
			steps {
				sh 'docker context use default'
				sh 'docker compose build'
				sh 'docker compose push'
			}
		}
        stage ('Terraform') {
            steps {
				sh 'terraform init'
                sh 'terraform apply -var \'sshPublicKeyPath=./.ssh/operator.pub\' --auto-approve'
            }
        }
	}
}